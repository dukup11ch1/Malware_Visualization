
var express = require('express');
var router = express.Router();
var multer = require('multer'); // express에 multer모듈 적용 (for 파일업로드)
var upload = multer({dest: appRoot + '/uploads/'});
var fs = require('fs');
var crypto = require("crypto");


const Account = require('../../database/account.js');
const peInfo = require('../../database/peInfo.js');
const File = require('../../database/file.js');

/* GET home page. */
router.post('/upload', upload.single('file'), function (req, res) {
    if (req.file.size > 20000000) {
        res.send(apiFail(999, "File too big"));
        return;
    }
    if (!isEmpty(req.session.account)) {
        get_account(req.session.account.username)
            .then(auth)
            .then(async (account) => {
                req.session.account.upload_limit -= 1;

                let isDupObj = await duplicateSha256(req.file.path);
                let fileObj = {
                    uuid: randomValueHex(32),
                    upload_by: account.username,
                    upload_by_username: account.username,
                    is_private: false,
                    downloadable: true,
                    original_name: req.file.originalname,
                    filename: req.file.filename,
                    path: req.file.path,
                    size: req.file.size,
                    reportId: !isDupObj.sha256 ? "none" : isDupObj.sha256,
                    process: !isDupObj.process ? 0 : isDupObj.process,
                    upload_date: Math.floor(new Date() / 1000)
                };

                return db_write(fileObj)
            })
            .then((db_data) => {

                res.locals.db_data = db_data;
                if (db_data.reportId === "none")
                    return uploadFtp(db_data.path, db_data.filename);
                else
                    return new Promise(resolve => resolve());
            })
            .then(() => {
                res.send(apiOk(0, {"redirect": "/report/u/" + res.locals.db_data.upload_by + "/f/" + res.locals.db_data.uuid}));
                // console.log(req.file);
            })
            .catch((err) => {
                res.send(apiFail(999, err));
            })
    } else {
        res.send(apiFail(3, "Login required"))
    }


    // res.send('Uploaded! : '); // object를 리턴함
});

router.get('/rescan/check/:upd', async (req, res) => {
    let updTime = !isEmpty(req.session.account) && req.session.account.api_level > 99 ? 180 : 3600;
    res.send(apiOk(0, {
        available: req.params.upd * 1 + updTime < Math.floor(new Date() / 1000),
        waitUntil: req.params.upd * 1 + updTime
    }))
});

router.get('/rescan/:fileId', async function (req, res) {
    console.log(req.params.fileId);
    let updTime = !isEmpty(req.session.account) && req.session.account.api_level > 99 ? 180 : 3600;
    let result = {
        success: true,
        message: '',
        code: 0
    };

    if (!isEmpty(req.session.account)) {

        let fileInfo = await getFileInfoByFileId(req.params.fileId);
        let reportInfo = await getReportInfo(fileInfo.reportId);

        if (reportInfo === false) {
            res.send(apiFail(404, 'reportNotFound'));
            return 0;
        }
        if (reportInfo.updateDate === undefined || reportInfo.updateDate + updTime < Math.floor(new Date() / 1000)) {
            console.log(appRoot + '/uploads/' + fileInfo.filename);
            if (fs.existsSync(appRoot + '/uploads/' + fileInfo.filename)) {
                // ftp upload

                if (await updateFileReportInfo(fileInfo.filename, {updateDate: Math.floor(new Date() / 1000)})) {

                    await uploadFtp(fileInfo.path, fileInfo.filename)
                    // if () {
                        // console.log('done');
                    // } else {
                    //     result.success = false;
                    //     result.message = 'File transfer Error. Try again later.';
                    //     result.code = 500
                    // }
                } else {
                    result.success = false;
                    result.message = 'Database error. Try again later.';
                    result.code = 500
                }
            } else {
                result.success = false;
                result.message = 'File not exist on server. Please upload same file again.';
                result.code = 999
            }
        } else {
            result.success = false;
            result.message = 'You can rescan after ' + updTime + 'second(s).';
            result.code = 999
        }
    } else {
        result.success = false;
        result.message = 'Login required';
        result.code = 3
    }

    if (result.success === true) {
        res.send(apiOk(0, {}))
    } else {
        res.send(apiFail(result.code, result.message))
    }
});

router.get('/myfiles', function (req, res) {
    get_account(req.session.account.username)
        .then(findMyFiles)
        .then((files) => res.send(apiOk(0, {files: files})))
        .catch(() => res.send(apiFail(999, "unknown error.")))
});

router.get('/myfiles/admin', function (req, res) {
    checkAdmin(req.session)
        .then(() => get_account(req.session.account.username))
        .then(findMyFiles_admin)
        .then((files) => res.send(apiOk(0, {files: files})))
        .catch(() => res.send(apiFail(999, "unknown error.")))
});

function getReportInfo(id) {
    return new Promise((resolve, reject) => {
        peInfo.findOne({pe_sha256: id}, (err, reportInfo) => {
            if (reportInfo)
                resolve(reportInfo);
            else
                resolve(false);
        });
    })
}

function updateFileReportInfo(fileId, data) {
    return new Promise(resolve => {
        peInfo.updateOne({uuid: fileId}, {
            $set: data
        }, function (err, result) {
            if (!err) {
                resolve(true);
            } else
                resolve(false);
        });
    })
}

function getFileInfoByFileId(fileId) {
    return new Promise(resolve => {
        File.findOne({uuid: fileId}, function (err, result) {
            if (result) {
                resolve(result);
            } else
                resolve(false);
        });
    })
} 

function checkAdmin(session) {
    return new Promise((resolve, reject) => {
        if (!isEmpty(session.account) && session.account.api_level > 99) {
            resolve();
        } else {
            reject();
        }
    });
}

function findMyFiles_admin(account) {
    return new Promise((resolve, reject) => {
        File.find({}, (err, file) => {
            let sendData = [];
            file.forEach((element) => {
                sendData.push({
                    uuid: element.uuid,
                    upload_by: element.upload_by,
                    upload_date: element.upload_date,
                    original_name: element.original_name,
                    reportId: element.reportId,
                    is_private: element.is_private,
                    url: '/report/u/' + element.upload_by + '/f/' + element.uuid,
                });
            });
            resolve(sendData);
        });
    })
}

function findMyFiles(account) {
    return new Promise((resolve, reject) => {
        File.find({'upload_by': account.username}, (err, file) => {
            let sendData = [];
            file.forEach((element) => {
                sendData.push({
                    uuid: element.uuid,
                    upload_by: element.upload_by,
                    upload_date: element.upload_date,
                    original_name: element.original_name,
                    reportId: element.reportId,
                    is_private: element.is_private,
                    url: '/report/u/' + element.upload_by + '/f/' + element.uuid,
                });
            });
            resolve(sendData);
        });
    })
}

function duplicateSha256(filepath) {
    return new Promise((resolve => {
        let algo = 'sha256';
        let shasum = crypto.createHash(algo);

        let s = fs.ReadStream(filepath);
        s.on('data', function (d) {
            shasum.update(d);
        });
        s.on('end', function () {
            var d = shasum.digest('hex').toUpperCase();
            peInfo.findOne({'pe_sha256': d}, (err, reportDoc) => {
                if (reportDoc) {
                    resolve({
                        sha256: d,
                        process: !reportDoc.idb_basicblock_matched ? 1 : 2
                    });
                } else {
                    resolve(false);
                }
            });
        });
    }))


}

function uploadFtp(path, filename) {
    var Client = require('ftp');
    var fs = require('fs');

    var c = new Client();

    return new Promise((resolve, reject) => {
        c.connect({
            host: "211.193.58.163",
            port: "33333",
            user: "client1",
            password: "qldhql12#$"
        });

        c.on('ready', function () {
            c.put(path, filename, function (err) {
                console.log("FTP!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!")
                console.log(path);
                if (err) {
                    console.log("--------------- FTP ERROR --------------");
                    console.log(err);
                    console.log("----------------------------------------");
                    reject("File server error. Try again later.");
                    return 0;
                }
                resolve();
                c.end();
            });
        });
    })
}

function get_account(username) {
    return new Promise((resolve, reject) => {
        Account.findOne({'username': username}, (err, account) => {
            if (account) {
                if (account.upload_reset_at < Math.floor(new Date() / 1000)) {
                    resolve(account);
                } else if (account.upload_limit > 0) {
                    resolve(account);
                } else {
                    reject("You have used all of your upload quota")
                }
            } else {
                reject("We can't find your account");
            }
        });
    })
}

function auth(account) {
    return new Promise((resolve, reject) => {
        if (account.upload_reset_at < Math.floor(new Date() / 1000)) {
            account.upload_reset_at = (Math.floor(new Date() / 1000) + 86400);
            account.upload_limit = 9;
        } else {
            account.upload_limit -= 1;
        }
        Account.updateOne({username: account.username}, {
            $set: {
                upload_limit: account.upload_limit,
                upload_reset_at: account.upload_reset_at,
            }
        }, function (err, result) {
            resolve(account)
        });
    })
}

function db_write(data) {
    var file = new File(data);

    return new Promise((resolve, reject) => {
        file.save()
            .then((res) => resolve(res))
            .catch((err) => reject(err))
    })
}

module.exports = router;
