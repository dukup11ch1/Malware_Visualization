import os
import pefile
import rich_analysis
import elasticsearch
import json
import elastic
from hashlib import sha256
def allfiles(path):
    res = []
    
    try :
        for _, _, files in os.walk(path):

            for file in files:
                filepath = os.path.join(path, file)
                res.append(filepath)
    except:
        pass
    return res
while True:
    filelist=allfiles('uploads')
    if filelist == []:
        continue
    else:
        for file_ in filelist:
            try:
                fp = open(file_,'rb')
                print(file_)
                pf=pefile.PE(file_)
                rich_info=rich_analysis.richheader(fp)
                sha256=sha256(fp.read()).hexdigest()
                fp.close()
                es = elasticsearch.Elasticsearch(['localhost:9200'])

                #Query_repre = {
                #    "query": {
                #        "bool": {
                #            "must": [
                #                { "match": { "sha256" : sha256 }}
                #            ]
                #        }    
                #    }
                #}
                #repre_query_result_list = elastic._search_query("rich", Query_repre,es)
                prodids=[]
                for info in rich_info.info:
                    prodids.append(info.prodid)
                data={
                    'sha256': sha256,
                    'info': prodids,
                }
                elastic.insert_data(data,es)
                #print(rich_info.info)
            except KeyboardInterrupt:
                exit()
            except ValueError:
                print(file_+' no have rich')
            finally:
                os.remove(file_)

                